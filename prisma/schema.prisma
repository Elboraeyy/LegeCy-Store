generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Customer Auth Domain
// ==========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String?
  emailVerified DateTime?
  image         String?   // Avatar from Google
  googleId      String?   @unique // Social Auth ID
  
  // Security Fields
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions      Session[]
  orders        Order[]
  cart          Cart?
  
  // Loyalty & Profile
  points        Int       @default(0)
  addresses     Address[]

  // CRM Fields
  phone         String?
  tags          String[]  @default([])
  notes         String?
  status        String    @default("active") // active, banned, archived
}

model Session {
  id        String   @id // @db.VarChar(64) - SQLite doesn't enforce length, but good for docs
  userId    String
  expiresAt DateTime
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  purpose   String   // 'email_verification' | 'password_reset'
  expiresAt DateTime
  createdAt DateTime @default(now())

  // No complex unique constraint needed if token is unique globally, 
  // but we can index email for lookup speed
  @@index([email])
}

// ==========================================
// Admin Auth Domain
// ==========================================

model AdminUser {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  username      String?   @unique  // Display name for sidebar
  
  roleId        String?
  role          AdminRole? @relation(fields: [roleId], references: [id])
  
  // Extended Profile Fields
  phone         String?
  nationalId    String?   @unique  // National ID / SSN
  idCardImage   String?            // URL to uploaded ID card image
  avatar        String?            // Profile picture URL
  birthDate     DateTime?
  address       String?
  emergencyContact String?         // Emergency contact info
  position      String?            // Job title/position
  salary        Decimal?           // Monthly salary
  hireDate      DateTime?          // Date joined the team
  notes         String?            // Internal notes about the team member
  
  // Security Fields
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions      AdminSession[]
  auditLogs     AuditLog[]
  orderNotes    OrderNote[]
}

model AdminRole {
  id          String      @id @default(uuid())
  name        String      @unique // super_admin, admin, support
  description String?
  permissions String      @default("") // CSV: ORDERS_READ,ORDERS_MANAGE
  admins      AdminUser[]
}

model AdminSession {
  id        String    @id // @db.VarChar(64)
  adminId   String
  expiresAt DateTime
  
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String   // e.g., "LOGIN", "VIEW_ORDERS", "CHANGE_ROLE"
  entityType String   // e.g., "ORDER", "USER", "SYSTEM"
  entityId   String?  // ID of the object being acted upon
  metadata   String?  // JSON string for extra details
  ipAddress  String?
  createdAt  DateTime @default(now())

  admin      AdminUser @relation(fields: [adminId], references: [id])
}

// ==========================================
// E-Commerce Domain (Existing)
// ==========================================

model Order {
  id         String               @id @default(uuid())
  totalPrice Decimal // @db.Decimal(10, 2)
  status     String               @default("pending")
  orderStatus OrderStatusEnum     @relation(fields: [status], references: [value])
  createdAt  DateTime             @default(now())

  userId     String?
  user       User?                @relation(fields: [userId], references: [id])

  // Shipping Information
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  shippingAddress String?
  shippingCity    String?
  shippingNotes   String?
  paymentMethod   String          @default("cod") // cod, paymob, fawry

  items      OrderItem[]
  history    OrderStatusHistory[]
  notes      OrderNote[]
  paymentIntent PaymentIntent?
  
  couponId   String?
  coupon     Coupon?              @relation(fields: [couponId], references: [id])

  // Returns & Loyalty
  returnRequest ReturnRequest?
  pointsEarned  Int            @default(0)
  pointsRedeemed Int           @default(0)

  // Performance indexes
  @@index([status])
  @@index([createdAt])
  @@index([userId])
}

model PaymentIntent {
  id                String   @id @default(uuid())
  orderId           String   @unique
  amount            Decimal // @db.Decimal(10, 2)
  currency          String   @default("EGP") // EGP, USD, etc
  provider          String   @default("paymob") // paymob, stripe, manual
  providerReference String?  // External ID (e.g. paymob_123456)
  status            String   @default("pending") // pending, succeeded, failed, expired
  statusRel         PaymentIntentStatusEnum @relation(fields: [status], references: [value])
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  order             Order    @relation(fields: [orderId], references: [id])
}

model ProcessedWebhookEvent {
  id          String   @id // Provider event ID (e.g. evt_xxx)
  provider    String   // stripe, paypal, etc
  eventType   String   // payment_intent.succeeded, etc
  entityId    String?  // Related order/payment ID
  processedAt DateTime @default(now())
  
  @@index([provider, entityId])
}

model PaymentIntentStatusEnum {
  value String @id
  intents PaymentIntent[]
}

model OrderStatusEnum {
  value String @id
  orders Order[]
}

model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String
  from      String
  to        String
  reason    String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id])
}

model OrderItem {
  id        String @id @default(uuid())
  productId String
  name      String
  price     Decimal // @db.Decimal(10, 2)
  quantity  Int
  orderId   String
  order     Order  @relation(fields: [orderId], references: [id])
  variantId String? // Optional for backward compatibility, required for new stock logic
  variant   Variant? @relation(fields: [variantId], references: [id])
}

model Product {
  id             String    @id @default(uuid())
  name           String
  description    String?
  imageUrl       String?   // Main Image
  images         ProductImage[]
  variants       Variant[]
  reviews        Review[]
  compareAtPrice Decimal?  // Original price for sale display
  status         String    @default("active") // active, draft, archived
  
  // Category relation
  categoryId     String?
  categoryRel    Category? @relation(fields: [categoryId], references: [id])
  category       String?   // Legacy string field for backward compatibility
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  cartItems      CartItem[]
  stockNotifications StockNotification[]
  
  // New Relations
  brandId        String?
  brand          Brand?    @relation(fields: [brandId], references: [id])
  
  materialId     String?
  material       Material? @relation(fields: [materialId], references: [id])

  @@index([name])
  @@index([category])
  @@index([status])
  @@index([categoryId])
  @@index([brandId])
  @@index([materialId])
}

// ==========================================
// Brand & Material Management
// ==========================================

model Brand {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  imageUrl    String?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Material {
  id          String    @id @default(uuid())
  name        String    @unique // e.g., "Leather", "Stainless Steel"
  slug        String    @unique
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ==========================================
// Reviews System
// ==========================================

model Review {
  id        String   @id @default(uuid())
  name      String   // Reviewer name
  rating    Int      // 1-5 stars
  text      String   // Review content
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  featured  Boolean  @default(false) // Show on homepage/product pages
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([featured])
}

// ==========================================
// Category Management
// ==========================================

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([parentId])
  @@index([sortOrder])
}

// ==========================================
// Order Internal Notes
// ==========================================

model OrderNote {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  adminId   String
  admin     AdminUser @relation(fields: [adminId], references: [id])
  content   String
  createdAt DateTime @default(now())

  @@index([orderId])
}

model ProductImage {
  id        String   @id @default(uuid())
  url       String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Variant {
  id        String      @id @default(uuid())
  productId String
  sku       String      @unique
  price     Decimal  // @db.Decimal(10, 2)
  product   Product     @relation(fields: [productId], references: [id])
  inventory Inventory[]
  orderItems OrderItem[]
  cartItems CartItem[]
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Warehouse {
  id        String      @id @default(uuid())
  name      String      @unique
  inventory Inventory[]
}

model Inventory {
  id          String    @id @default(uuid())
  warehouseId String
  variantId   String
  available   Int       @default(0)
  reserved    Int       @default(0)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  variant     Variant   @relation(fields: [variantId], references: [id])
  updatedAt   DateTime  @updatedAt

  @@unique([warehouseId, variantId])
}

// ==========================================
// Cart & Wishlist Domain
// ==========================================

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  abandonedEmailSent Boolean @default(false)
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  variantId String?
  variant   Variant? @relation(fields: [variantId], references: [id])
  quantity  Int      @default(1)
  
  @@unique([cartId, productId, variantId])
}

// ==========================================
// User Details Domain
// ==========================================

model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   @default("home") // home, work
  name      String
  phone     String
  street    String
  city      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model ReturnRequest {
  id        String   @id @default(uuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  reason    String
  items     Json?    // Snapshot of items being returned: [{ sku: '...', qty: 1 }]
  status    String   @default("pending") // pending, approved, rejected, completed
  adminNote String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// Marketing & Promotions
// ==========================================

model Coupon {
  id            String    @id @default(uuid())
  code          String    @unique
  discountType  String    // PERCENTAGE, FIXED_AMOUNT
  discountValue Decimal
  minOrderValue Decimal?
  maxDiscount   Decimal?
  startDate     DateTime  @default(now())
  endDate       DateTime?
  usageLimit    Int?      // Total global usage limit
  currentUsage  Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
}

model StockNotification {
  id        String   @id @default(uuid())
  email     String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  status    String   @default("pending") // pending, sent
  createdAt DateTime @default(now())

  @@index([email])
}

model StoreConfig {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "homepage_hero", "site_settings"
  value     Json     // Flexible JSON payload
  updatedAt DateTime @updatedAt
}
