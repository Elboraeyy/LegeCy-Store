generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Customer Auth Domain
// ==========================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String?
  emailVerified DateTime?
  image         String?   // Avatar from Google
  googleId      String?   @unique // Social Auth ID
  facebookId    String?   @unique // Facebook Auth ID
  
  // Security Fields
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions      Session[]
  orders        Order[]
  cart          Cart?
  
  // Loyalty & Profile
  points        Int       @default(0)
  addresses     Address[]

  // CRM Fields
  phone         String?
  tags          String[]  @default([])
  notes         String?
  status        String    @default("active") // active, banned, archived
  
  // POS Relations
  posTransactions POSTransaction[]
}

model Session {
  id        String   @id // @db.VarChar(64) - SQLite doesn't enforce length, but good for docs
  userId    String
  expiresAt DateTime
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  purpose   String   // 'email_verification' | 'password_reset'
  expiresAt DateTime
  createdAt DateTime @default(now())

  // No complex unique constraint needed if token is unique globally, 
  // but we can index email for lookup speed
  @@index([email])
}

// ==========================================
// Admin Auth Domain
// ==========================================

model AdminUser {
  id            String    @id @default(uuid())
  email         String    @unique
  passwordHash  String
  name          String
  username      String?   @unique  // Display name for sidebar
  
  roleId        String?
  role          AdminRole? @relation(fields: [roleId], references: [id])
  
  // Extended Profile Fields
  phone         String?
  nationalId    String?   @unique  // National ID / SSN
  idCardImage   String?            // URL to uploaded ID card image
  avatar        String?            // Profile picture URL
  birthDate     DateTime?
  address       String?
  emergencyContact String?         // Emergency contact info
  position      String?            // Job title/position
  salary        Decimal?           // Monthly salary
  hireDate      DateTime?          // Date joined the team
  notes         String?            // Internal notes about the team member
  
  // Security Fields
  isActive      Boolean   @default(true)
  lastLoginAt   DateTime?
  failedLoginAttempts Int      @default(0)
  lockedUntil         DateTime?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  sessions      AdminSession[]
  auditLogs     AuditLog[]
  inventoryLogs InventoryLog[]
  orderNotes    OrderNote[]
  
  // WMS Relations
  managedWarehouses    Warehouse[]
  createdTransfers     StockTransfer[] @relation("TransferCreatedBy")
  approvedTransfers    StockTransfer[] @relation("TransferApprovedBy")
  resolvedAlerts       StockAlert[]
  createdCounts        InventoryCount[] @relation("CountCreatedBy")
  completedCounts      InventoryCount[] @relation("CountCompletedBy")
  
  // POS Relations
  posSessions          POSSession[]
}

model AdminRole {
  id          String      @id @default(uuid())
  name        String      @unique // super_admin, admin, support
  description String?
  permissions String      @default("") // CSV: ORDERS_READ,ORDERS_MANAGE
  admins      AdminUser[]
}

model AdminSession {
  id        String    @id // @db.VarChar(64)
  adminId   String
  expiresAt DateTime
  
  admin     AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String   // e.g., "LOGIN", "VIEW_ORDERS", "CHANGE_ROLE"
  entityType String   // e.g., "ORDER", "USER", "SYSTEM"
  entityId   String?  // ID of the object being acted upon
  metadata   String?  // JSON string for extra details
  ipAddress  String?
  createdAt  DateTime @default(now())

  admin      AdminUser @relation(fields: [adminId], references: [id])
}

// ==========================================
// E-Commerce Domain (Existing)
// ==========================================

model Order {
  id         String               @id @default(uuid())
  totalPrice Decimal // @db.Decimal(10, 2)
  status     String               @default("pending")
  orderStatus OrderStatusEnum     @relation(fields: [status], references: [value])
  createdAt  DateTime             @default(now())
  deliveredAt DateTime?            // Actual delivery date for return window

  userId     String?
  user       User?                @relation(fields: [userId], references: [id])

  // Shipping Information
  customerName    String?
  customerEmail   String?
  customerPhone   String?
  shippingAddress String?
  shippingCity    String?
  shippingNotes   String?
  paymentMethod   String          @default("cod") // cod, paymob, fawry

  items      OrderItem[]
  history    OrderStatusHistory[]
  notes      OrderNote[]
  paymentIntent PaymentIntent?
  
  couponId   String?
  coupon     Coupon?              @relation(fields: [couponId], references: [id])

  // Returns & Loyalty
  returnRequest ReturnRequest?
  pointsEarned  Int            @default(0)
  pointsRedeemed Int           @default(0)

  // Idempotency for checkout safety
  idempotencyKey String?       @unique
  
  // Order source tracking
  orderSource    String        @default("online") // online, whatsapp, instagram, facebook, call, pos

  // Coupon usage tracking
  couponUsage   CouponUsage?

  // Performance indexes
  @@index([status])
  @@index([createdAt])
  @@index([userId])
  @@index([idempotencyKey])
  @@index([customerEmail])
  @@index([paymentMethod])
  @@index([orderSource])
}

model PaymentIntent {
  id                String   @id @default(uuid())
  orderId           String   @unique
  amount            Decimal // @db.Decimal(10, 2)
  currency          String   @default("EGP") // EGP, USD, etc
  provider          String   @default("paymob") // paymob, stripe, manual
  providerReference String?  // External ID (e.g. paymob_123456)
  status            String   @default("pending") // pending, succeeded, failed, expired
  statusRel         PaymentIntentStatusEnum @relation(fields: [status], references: [value])
  expiresAt         DateTime
  createdAt         DateTime @default(now())
  order             Order    @relation(fields: [orderId], references: [id])
}

model ProcessedWebhookEvent {
  id          String   @id // Provider event ID (e.g. evt_xxx)
  provider    String   // stripe, paypal, etc
  eventType   String   // payment_intent.succeeded, etc
  entityId    String?  // Related order/payment ID
  processedAt DateTime @default(now())
  
  @@index([provider, entityId])
}

model PaymentIntentStatusEnum {
  value String @id
  intents PaymentIntent[]
}

model OrderStatusEnum {
  value String @id
  orders Order[]
}

model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String
  from      String
  to        String
  reason    String?
  createdAt DateTime    @default(now())
  order     Order       @relation(fields: [orderId], references: [id])
}

model OrderItem {
  id        String @id @default(uuid())
  productId String
  name      String
  sku       String? // SKU snapshot at time of order (for historical reference)
  price     Decimal // @db.Decimal(10, 2)
  quantity  Int
  orderId   String
  order     Order  @relation(fields: [orderId], references: [id])
  variantId String? // Optional for backward compatibility, required for new stock logic
  variant   Variant? @relation(fields: [variantId], references: [id])
}

model Product {
  id             String    @id @default(uuid())
  name           String
  description    String?
  imageUrl       String?   // Main Image
  images         ProductImage[]
  variants       Variant[]
  reviews        Review[]
  compareAtPrice Decimal?  // Original price for sale display
  status         String    @default("active") // active, draft, archived
  
  // Category relation
  categoryId     String?
  categoryRel    Category? @relation(fields: [categoryId], references: [id])
  category       String?   // Legacy string field for backward compatibility
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  cartItems      CartItem[]
  stockNotifications StockNotification[]
  
  // New Relations
  brandId        String?
  brand          Brand?    @relation(fields: [brandId], references: [id])
  
  materialId     String?
  material       Material? @relation(fields: [materialId], references: [id])

  @@index([name])
  @@index([category])
  @@index([status])
  @@index([categoryId])
  @@index([brandId])
  @@index([materialId])
}

// ==========================================
// Brand & Material Management
// ==========================================

model Brand {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  imageUrl    String?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Material {
  id          String    @id @default(uuid())
  name        String    @unique // e.g., "Leather", "Stainless Steel"
  slug        String    @unique
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ==========================================
// Reviews System
// ==========================================

model Review {
  id        String   @id @default(uuid())
  name      String   // Reviewer name
  rating    Int      // 1-5 stars
  text      String   // Review content
  productId String?
  product   Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
  featured  Boolean  @default(false) // Show on homepage/product pages
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([featured])
}

// ==========================================
// Category Management
// ==========================================

model Category {
  id          String     @id @default(uuid())
  name        String
  slug        String     @unique
  description String?
  parentId    String?
  parent      Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([parentId])
  @@index([sortOrder])
}

// ==========================================
// Order Internal Notes
// ==========================================

model OrderNote {
  id        String   @id @default(uuid())
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  adminId   String
  admin     AdminUser @relation(fields: [adminId], references: [id])
  content   String
  createdAt DateTime @default(now())

  @@index([orderId])
}

model ProductImage {
  id        String   @id @default(uuid())
  url       String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
}

model Variant {
  id        String      @id @default(uuid())
  productId String
  sku       String      @unique
  price     Decimal  // @db.Decimal(10, 2)
  product   Product     @relation(fields: [productId], references: [id])
  inventory Inventory[]
  inventoryLogs InventoryLog[]
  orderItems OrderItem[]
  cartItems CartItem[]
  
  // WMS Relations
  stockTransferItems   StockTransferItem[]
  stockAlerts          StockAlert[]
  inventoryCountItems  InventoryCountItem[]
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model Warehouse {
  id        String      @id @default(uuid())
  name      String      @unique
  code      String?     @unique  // Short code like "WH-CAIRO-01"
  
  // Location
  address   String?
  city      String?
  country   String      @default("Egypt")
  
  // Contact
  phone     String?
  email     String?
  
  // Management
  managerId String?
  manager   AdminUser?  @relation(fields: [managerId], references: [id])
  
  // Classification
  type      String      @default("MAIN")  // MAIN, REGIONAL, DROPSHIP, RETURNS
  isActive  Boolean     @default(true)
  notes     String?
  
  // Relations
  inventory Inventory[]
  inventoryLogs InventoryLog[]
  stockTransfersFrom StockTransfer[] @relation("TransferFrom")
  stockTransfersTo   StockTransfer[] @relation("TransferTo")
  stockAlerts        StockAlert[]
  inventoryCounts    InventoryCount[]
  
  // POS Relations
  posTerminals       POSTerminal[]
  
  createdAt DateTime    @default(now())
  updatedAt DateTime    @default(now()) @updatedAt
}

model Inventory {
  id          String    @id @default(uuid())
  warehouseId String
  variantId   String
  available   Int       @default(0)
  reserved    Int       @default(0)
  minStock    Int       @default(5)
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  variant     Variant   @relation(fields: [variantId], references: [id])
  updatedAt   DateTime  @updatedAt

  @@unique([warehouseId, variantId])
}

model InventoryLog {
  id          String    @id @default(uuid())
  warehouseId String
  variantId   String
  
  action      String    // ADJUST, TRANSFER_OUT, TRANSFER_IN, ORDER_ALLOCATE, ORDER_FULFILL, RETURN
  quantity    Int       // The delta (+/-)
  balanceAfter Int?     // Snapshot of available stock after change
  reason      String?
  referenceId String?   // Order ID or Transfer ID
  
  adminId     String?
  admin       AdminUser? @relation(fields: [adminId], references: [id])
  
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])
  variant     Variant   @relation(fields: [variantId], references: [id])
  
  createdAt   DateTime  @default(now())

  @@index([warehouseId])
  @@index([variantId])
  @@index([createdAt])
  @@index([action])
}

// ==========================================
// Stock Transfer System
// ==========================================

model StockTransfer {
  id              String    @id @default(uuid())
  transferNumber  String    @unique @default(uuid())  // Human-readable reference
  
  fromWarehouseId String
  toWarehouseId   String
  fromWarehouse   Warehouse @relation("TransferFrom", fields: [fromWarehouseId], references: [id])
  toWarehouse     Warehouse @relation("TransferTo", fields: [toWarehouseId], references: [id])
  
  status          String    @default("PENDING")  // PENDING, APPROVED, IN_TRANSIT, RECEIVED, CANCELLED
  
  // Metadata
  notes           String?
  createdById     String?
  createdBy       AdminUser? @relation("TransferCreatedBy", fields: [createdById], references: [id])
  approvedById    String?
  approvedBy      AdminUser? @relation("TransferApprovedBy", fields: [approvedById], references: [id])
  
  // Timestamps
  createdAt       DateTime  @default(now())
  approvedAt      DateTime?
  shippedAt       DateTime?
  receivedAt      DateTime?
  cancelledAt     DateTime?
  cancelReason    String?
  
  // Items
  items           StockTransferItem[]
  
  @@index([status])
  @@index([fromWarehouseId])
  @@index([toWarehouseId])
  @@index([createdAt])
}

model StockTransferItem {
  id              String        @id @default(uuid())
  transferId      String
  transfer        StockTransfer @relation(fields: [transferId], references: [id], onDelete: Cascade)
  
  variantId       String
  variant         Variant       @relation(fields: [variantId], references: [id])
  
  requestedQty    Int           // Quantity requested to transfer
  sentQty         Int?          // Quantity actually sent (may differ)
  receivedQty     Int?          // Quantity received (may differ due to damage/loss)
  
  notes           String?       // Per-item notes (damage, discrepancy)
  
  @@index([transferId])
  @@index([variantId])
}

// ==========================================
// Stock Alerts System
// ==========================================

model StockAlert {
  id              String    @id @default(uuid())
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  
  variantId       String
  variant         Variant   @relation(fields: [variantId], references: [id])
  
  alertType       String    // LOW_STOCK, OUT_OF_STOCK, OVERSTOCK
  threshold       Int       // The threshold that was breached
  currentStock    Int       // Stock level when alert was created
  
  status          String    @default("NEW")  // NEW, ACKNOWLEDGED, RESOLVED
  
  // Resolution
  resolvedById    String?
  resolvedBy      AdminUser? @relation(fields: [resolvedById], references: [id])
  resolvedAt      DateTime?
  resolvedNote    String?
  
  createdAt       DateTime  @default(now())
  
  @@index([status])
  @@index([alertType])
  @@index([warehouseId])
  @@index([variantId])
  @@index([createdAt])
}

// ==========================================
// Stock Counting (Physical Inventory Audit)
// ==========================================

model InventoryCount {
  id              String    @id @default(uuid())
  countNumber     String    @unique @default(uuid())  // Human-readable reference
  
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  
  status          String    @default("DRAFT")  // DRAFT, IN_PROGRESS, COMPLETED, CANCELLED
  
  // Metadata
  createdById     String?
  createdBy       AdminUser? @relation("CountCreatedBy", fields: [createdById], references: [id])
  completedById   String?
  completedBy     AdminUser? @relation("CountCompletedBy", fields: [completedById], references: [id])
  
  countDate       DateTime  @default(now())  // Date of physical count
  notes           String?
  
  // Timestamps
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  
  // Items
  items           InventoryCountItem[]
  
  @@index([status])
  @@index([warehouseId])
  @@index([countDate])
}

model InventoryCountItem {
  id              String         @id @default(uuid())
  countId         String
  count           InventoryCount @relation(fields: [countId], references: [id], onDelete: Cascade)
  
  variantId       String
  variant         Variant        @relation(fields: [variantId], references: [id])
  
  systemQty       Int            // System quantity at time of count
  countedQty      Int?           // Physically counted quantity
  variance        Int?           // Difference (countedQty - systemQty)
  
  notes           String?        // Reason for variance
  countedAt       DateTime?      // When this item was counted
  
  @@index([countId])
  @@index([variantId])
}

// ==========================================
// Cart & Wishlist Domain
// ==========================================

model Cart {
  id        String     @id @default(uuid())
  userId    String     @unique
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items     CartItem[]
  abandonedEmailSent Boolean @default(false)
  updatedAt DateTime   @updatedAt
}

model CartItem {
  id        String   @id @default(uuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  variantId String?
  variant   Variant? @relation(fields: [variantId], references: [id])
  quantity  Int      @default(1)
  
  @@unique([cartId, productId, variantId])
}

// ==========================================
// User Details Domain
// ==========================================

model Address {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      String   @default("home") // home, work
  name      String
  phone     String
  street    String
  city      String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([userId])
}

model ReturnRequest {
  id        String   @id @default(uuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  reason    String
  items     Json?    // Snapshot of items being returned: [{ sku: '...', qty: 1 }]
  status    String   @default("pending") // pending, approved, rejected, completed
  adminNote String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==========================================
// Marketing & Promotions
// ==========================================

model Coupon {
  id            String    @id @default(uuid())
  code          String    @unique
  discountType  String    // PERCENTAGE, FIXED_AMOUNT
  discountValue Decimal
  minOrderValue Decimal?
  maxDiscount   Decimal?
  startDate     DateTime  @default(now())
  endDate       DateTime?
  usageLimit    Int?      // Total global usage limit
  currentUsage  Int       @default(0)
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
  usages        CouponUsage[]

  @@index([isActive])
  @@index([startDate, endDate])
}

// Per-user coupon usage tracking to prevent abuse
model CouponUsage {
  id        String   @id @default(uuid())
  couponId  String
  coupon    Coupon   @relation(fields: [couponId], references: [id])
  userId    String?
  userEmail String
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  usedAt    DateTime @default(now())
  
  @@unique([couponId, userId])
  @@unique([couponId, userEmail])
  @@index([couponId])
}

// Price history for audit trail (Issue #7)
model ProductPriceHistory {
  id         String   @id @default(uuid())
  productId  String
  variantId  String?
  oldPrice   Decimal
  newPrice   Decimal
  changedBy  String?  // AdminUser ID who made the change
  reason     String?  // Optional reason for change
  createdAt  DateTime @default(now())
  
  @@index([productId])
  @@index([variantId])
  @@index([createdAt])
}

model StockNotification {
  id        String   @id @default(uuid())
  email     String
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  status    String   @default("pending") // pending, sent
  createdAt DateTime @default(now())

  @@index([email])
}

model StoreConfig {
  id        String   @id @default(uuid())
  key       String   @unique // e.g., "homepage_hero", "site_settings"
  value     Json     // Flexible JSON payload
  updatedAt DateTime @updatedAt
}

// ==========================================
// Email Queue (Reliable Delivery)
// ==========================================

model EmailQueue {
  id          String   @id @default(uuid())
  to          String
  subject     String
  html        String   @db.Text
  status      String   @default("pending") // pending, sent, failed
  attempts    Int      @default(0)
  maxAttempts Int      @default(3)
  error       String?
  scheduledAt DateTime @default(now())
  sentAt      DateTime?
  createdAt   DateTime @default(now())
  
  @@index([status])
  @@index([scheduledAt])
}

// ==========================================
// POS (Point of Sale) Domain
// ==========================================

// POS Terminal (Physical/Logical Terminal)
model POSTerminal {
  id              String   @id @default(uuid())
  name            String   @unique // "Terminal 1", "Mobile POS"
  code            String   @unique // "POS-01"
  
  // Location
  warehouseId     String
  warehouse       Warehouse @relation(fields: [warehouseId], references: [id])
  
  // Hardware Config
  printerType     String?  // THERMAL_80MM, THERMAL_58MM, A4
  printerAddress  String?  // IP or USB path
  drawerEnabled   Boolean  @default(false)
  scannerMode     String   @default("KEYBOARD") // KEYBOARD, SERIAL, USB
  
  // Display
  customerDisplay Boolean  @default(false)
  displayAddress  String?
  
  // Settings
  isActive        Boolean  @default(true)
  settings        Json?    // Terminal-specific settings
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  sessions        POSSession[]
  quickKeys       POSQuickKey[]
  
  @@index([warehouseId])
  @@index([isActive])
}

// POS Session (Shift Management)
model POSSession {
  id              String   @id @default(uuid())
  sessionNo       String   @unique @default(uuid()) // Human-readable reference
  
  cashierId       String
  cashier         AdminUser @relation(fields: [cashierId], references: [id])
  terminalId      String
  terminal        POSTerminal @relation(fields: [terminalId], references: [id])
  
  // Shift Times
  startedAt       DateTime @default(now())
  endedAt         DateTime?
  
  // Cash Management
  openingBalance  Decimal  @default(0)
  closingBalance  Decimal?
  expectedBalance Decimal?
  difference      Decimal?
  
  // Counters
  salesCount      Int      @default(0)
  refundsCount    Int      @default(0)
  voidCount       Int      @default(0)
  
  // Totals
  salesTotal      Decimal  @default(0)
  refundsTotal    Decimal  @default(0)
  discountsTotal  Decimal  @default(0)
  taxTotal        Decimal  @default(0)
  
  // Status
  status          String   @default("OPEN") // OPEN, PAUSED, CLOSED
  closingNote     String?
  
  transactions    POSTransaction[]
  cashMovements   CashMovement[]
  heldTransactions POSHeldTransaction[]
  
  @@index([cashierId])
  @@index([terminalId])
  @@index([status])
  @@index([startedAt])
}

// POS Transaction (Every sale/refund/void)
model POSTransaction {
  id              String   @id @default(uuid())
  transactionNo   String   @unique // POS-2024-000001
  
  sessionId       String
  session         POSSession @relation(fields: [sessionId], references: [id])
  
  // Transaction Type
  type            String   @default("SALE") // SALE, REFUND, EXCHANGE, VOID
  
  // Customer (optional for walk-in)
  customerId      String?
  customer        User?    @relation(fields: [customerId], references: [id])
  customerName    String?
  customerPhone   String?
  
  // Items
  items           POSTransactionItem[]
  
  // Totals
  subtotal        Decimal
  discountAmount  Decimal  @default(0)
  discountType    String?  // PERCENTAGE, FIXED, COUPON
  discountReason  String?
  couponId        String?
  taxAmount       Decimal  @default(0)
  total           Decimal
  
  // Payments
  payments        POSPayment[]
  changeDue       Decimal  @default(0)
  
  // Status
  status          String   @default("COMPLETED") // PENDING, COMPLETED, VOIDED, REFUNDED
  voidReason      String?
  voidedById      String?
  voidedAt        DateTime?
  
  // E-commerce link (optional)
  linkedOrderId   String?
  
  // Receipt
  receiptPrinted  Boolean  @default(false)
  note            String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([sessionId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@index([customerId])
  @@index([transactionNo])
}

// Transaction Items
model POSTransactionItem {
  id              String   @id @default(uuid())
  transactionId   String
  transaction     POSTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  productId       String
  variantId       String?
  
  // Snapshot at time of sale
  name            String
  sku             String
  barcode         String?
  imageUrl        String?
  
  quantity        Int
  unitPrice       Decimal
  discountAmount  Decimal  @default(0)
  taxAmount       Decimal  @default(0)
  totalPrice      Decimal
  
  // For returns
  isReturn        Boolean  @default(false)
  originalItemId  String?  // Link to original item if return
  returnReason    String?
  
  @@index([transactionId])
  @@index([productId])
  @@index([variantId])
  @@index([sku])
}

// Payment Methods for Transaction
model POSPayment {
  id              String   @id @default(uuid())
  transactionId   String
  transaction     POSTransaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  
  method          String   // CASH, CARD, MOBILE_WALLET, VOUCHER
  amount          Decimal
  reference       String?  // Card last 4 digits, wallet number, voucher code
  
  // For card payments
  cardType        String?  // VISA, MASTERCARD, MEEZA, etc.
  approvalCode    String?
  
  createdAt       DateTime @default(now())
  
  @@index([transactionId])
  @@index([method])
}

// Cash Drawer Movements
model CashMovement {
  id              String   @id @default(uuid())
  sessionId       String
  session         POSSession @relation(fields: [sessionId], references: [id])
  
  type            String   // PAY_IN, PAY_OUT, FLOAT, DROP, SALE, REFUND
  amount          Decimal
  reason          String?
  reference       String?  // Transaction ID if related to sale/refund
  
  balanceAfter    Decimal
  
  performedById   String?
  
  createdAt       DateTime @default(now())
  
  @@index([sessionId])
  @@index([type])
  @@index([createdAt])
}

// Quick Keys / Favorites
model POSQuickKey {
  id              String   @id @default(uuid())
  
  // Can be global or per-terminal
  terminalId      String?
  terminal        POSTerminal? @relation(fields: [terminalId], references: [id])
  
  // What it points to
  type            String   // PRODUCT, CATEGORY, DISCOUNT, ACTION
  referenceId     String?  // Product/Category ID
  
  // Discount settings (when type is DISCOUNT)
  discountType    String?  // PERCENTAGE, FIXED
  discountValue   Decimal?
  
  // Display
  label           String
  color           String   @default("#3b82f6")
  icon            String?
  gridRow         Int      @default(0)
  gridCol         Int      @default(0)
  
  // Shortcut
  keyboardShortcut String?  // e.g., "F1", "Ctrl+1"
  
  isActive        Boolean  @default(true)
  
  @@index([terminalId])
  @@index([type])
  @@index([isActive])
}

// Held Transactions (Park & Retrieve)
model POSHeldTransaction {
  id              String   @id @default(uuid())
  sessionId       String
  session         POSSession @relation(fields: [sessionId], references: [id])
  
  // Customer info
  customerName    String?
  customerPhone   String?
  
  // Held items as JSON snapshot
  items           Json
  subtotal        Decimal
  discountAmount  Decimal  @default(0)
  
  note            String?
  createdAt       DateTime @default(now())
  expiresAt       DateTime // Auto-delete after X hours
  
  @@index([sessionId])
  @@index([createdAt])
  @@index([expiresAt])
}

